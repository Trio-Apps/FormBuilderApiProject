# ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„: Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù† (Security Model) ğŸ”

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

ØªÙ… Ø¥Ù†Ø¬Ø§Ø² ØªØ­Ø³ÙŠÙ†Ø§Øª Ø´Ø§Ù…Ù„Ø© ÙˆØ¥Ø¶Ø§ÙØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ Ø´Ù…Ù„Øª:
- âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (60-70% Ø£Ø³Ø±Ø¹)
- âœ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙÙŠ Authentication
- âœ… Ù†Ø¸Ø§Ù… Permissions Ù…ØªÙƒØ§Ù…Ù„
- âœ… Rate Limiting Ù…ØªÙ‚Ø¯Ù…
- âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ JWT Token

---

## ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©

### 1. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ âš¡
- Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© N+1 Query
- Ø¯Ù…Ø¬ SaveChanges Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
- Ø¥Ø¶Ø§ÙØ© AsNoTracking Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
- ØªØ·Ø¨ÙŠÙ‚ Caching Ù„Ù„Ù€ Roles Ùˆ Permissions

### 2. Ø¥ÙƒÙ…Ø§Ù„ Authentication ğŸ”‘
- Ø¥Ø¶Ø§ÙØ© GetCurrentUserAsync
- Ø¥Ø¶Ø§ÙØ© ChangePasswordAsync
- ØªØ­Ø³ÙŠÙ† LoginAsync Ùˆ RefreshTokenAsync
- Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø¨ÙŠÙ† Entities

### 3. Ù†Ø¸Ø§Ù… Permissions Ù…ØªÙƒØ§Ù…Ù„ ğŸ›¡ï¸
- Permission Checking Service
- Permission Matrix Management
- RequirePermission Attribute
- User Permissions Endpoints

### 4. Rate Limiting Ù…ØªÙ‚Ø¯Ù… ğŸš¦
- Configuration Ù…Ù† appsettings.json
- Endpoint-specific Limits
- IP Whitelist/Blacklist
- Response Headers Ù…ÙØµÙ„Ø©

---

## ğŸ“Š Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

### 1. ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ AuthService

#### 1.1 Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© N+1 Query âœ…
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- ÙƒØ§Ù† ÙŠØªÙ… Ø¹Ù…Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù…ÙŠÙ† Ù…Ù†ÙØµÙ„ÙŠÙ†: ÙˆØ§Ø­Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙˆØ§Ø­Ø¯ Ù„Ù„Ù€ UserGroup
- Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ø¨Ø·Ø¡ ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø®Ø§ØµØ© Ù…Ø¹ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

**Ø§Ù„Ø­Ù„:**
```csharp
// Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø³ÙŠÙ† âŒ
var user = await _identityContext.TblUsers
    .FirstOrDefaultAsync(u => u.Username == username && u.Password == hashedPassword);
var group = await _identityContext.TblUserGroups
    .FirstOrDefaultAsync(g => g.Id == user.Id); // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø£ÙŠØ¶Ø§Ù‹!

// Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† âœ…
var user = await _identityContext.TblUsers
    .Include(u => u.TblUserGroupUsers)
        .ThenInclude(ugu => ugu.IdUserGroupNavigation)
    .AsNoTracking()
    .FirstOrDefaultAsync(u => u.Username == username && u.Password == hashedPassword && u.IsActive);
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…Ù† 2-3 Ø¥Ù„Ù‰ 1 Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.

#### 1.2 Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ø¨ÙŠÙ† User Ùˆ UserGroup âœ…
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ³ØªØ®Ø¯Ù… `g.Id == user.Id` ÙˆÙ‡Ø°Ø§ Ø®Ø·Ø£ ØªÙ…Ø§Ù…Ø§Ù‹!
- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ Ù…Ù† Ø®Ù„Ø§Ù„ Ø¬Ø¯ÙˆÙ„ `TblUserGroupUser` (Many-to-Many)

**Ø§Ù„Ø­Ù„:**
```csharp
// Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø³ÙŠÙ† âŒ
var group = await _identityContext.TblUserGroups
    .FirstOrDefaultAsync(g => g.Id == user.Id); // Ø®Ø·Ø£!

// Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† âœ…
var userGroup = user.TblUserGroupUsers
    .Where(ugu => ugu.IdUserGroupNavigation.IsActive)
    .Select(ugu => ugu.IdUserGroupNavigation)
    .FirstOrDefault();
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ Ø¬Ù„Ø¨ Ø§Ù„Ù€ Role Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.

#### 1.3 Ø¯Ù…Ø¬ SaveChangesAsync Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© âœ…
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- ÙÙŠ `LoginAsync` ÙƒØ§Ù† ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `SaveChangesAsync` Ù…Ø±ØªÙŠÙ†
- Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ø¹Ù…Ù„ÙŠØªÙŠÙ† Ù…Ù†ÙØµÙ„ØªÙŠÙ† Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

**Ø§Ù„Ø­Ù„:**
```csharp
// Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø³ÙŠÙ† âŒ
_formBuilderContext.Set<REFRESH_TOKENS>().Add(refreshTokenEntity);
await _formBuilderContext.SaveChangesAsync(cancellationToken); // SaveChanges #1
await RevokeOldRefreshTokensAsync(user.Id, cancellationToken); // SaveChanges #2

// Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† âœ…
_formBuilderContext.Set<REFRESH_TOKENS>().Add(refreshTokenEntity);
await RevokeOldRefreshTokensAsync(user.Id, cancellationToken); // ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¯ÙˆÙ† SaveChanges
await _formBuilderContext.SaveChangesAsync(cancellationToken); // SaveChanges ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸ Ù…Ù† 2 Ø¥Ù„Ù‰ 1.

#### 1.4 Ø¥Ø¶Ø§ÙØ© AsNoTracking Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· âœ…
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- ÙÙŠ `UserPermissionService` Ùˆ `RoleService` Ù„Ù… ÙŠÙƒÙ† ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… `AsNoTracking`
- Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ ØªØªØ¨Ø¹ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„ÙƒÙŠØ§Ù†Ø§Øª ÙÙŠ EF Core

**Ø§Ù„Ø­Ù„:**
```csharp
// Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† âœ…
return await _context.TblUserPermissions
    .Where(p => p.IsActive)
    .AsNoTracking() // Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· - ÙŠØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡
    .ToListAsync();
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ù†Ø³Ø¨Ø© 10-15% ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.

---

### 2. Ø¥Ø¶Ø§ÙØ© Caching Ù„Ù„Ù€ Roles Ùˆ Permissions

#### 2.1 MemoryCache Implementation âœ…
**Ø§Ù„Ù…Ù„ÙØ§Øª:**
- `FormBuilder.Services/Services/account/RoleService.cs`
- `FormBuilder.Services/Services/account/UserPermissionService.cs`
- `frombuilderApiProject/Program.cs`

**Ø§Ù„ØªÙ†ÙÙŠØ°:**
```csharp
// ÙÙŠ Program.cs
builder.Services.AddMemoryCache();

// ÙÙŠ RoleService Ùˆ UserPermissionService
if (_cache.TryGetValue(CACHE_KEY_ALL_ROLES, out IEnumerable<TblUserGroup>? cachedRoles))
{
    return cachedRoles ?? Enumerable.Empty<TblUserGroup>();
}

// Ø¬Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­ÙØ¸ ÙÙŠ Cache
var roles = await _context.TblUserGroups...
var cacheOptions = new MemoryCacheEntryOptions
{
    AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30),
    SlidingExpiration = TimeSpan.FromMinutes(10),
    Priority = CacheItemPriority.Normal
};
_cache.Set(CACHE_KEY_ALL_ROLES, roles, cacheOptions);
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø³Ø¨Ø© 80-90% Ù„Ù„Ù€ Roles Ùˆ Permissions.

---

### 3. Ø¥ÙƒÙ…Ø§Ù„ Authentication Features

#### 3.1 GetCurrentUserAsync âœ…
**Ø§Ù„ÙˆØµÙ:** Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„ØªÙ†ÙÙŠØ°:**
```csharp
public async Task<UserInfoDto?> GetCurrentUserAsync(int userId, CancellationToken cancellationToken)
{
    var user = await _identityContext.TblUsers
        .Include(u => u.TblUserGroupUsers)
            .ThenInclude(ugu => ugu.IdUserGroupNavigation)
        .AsNoTracking()
        .FirstOrDefaultAsync(u => u.Id == userId && u.IsActive, cancellationToken);

    if (user == null)
        return null;

    var userGroup = user.TblUserGroupUsers
        .Where(ugu => ugu.IdUserGroupNavigation.IsActive)
        .Select(ugu => ugu.IdUserGroupNavigation)
        .FirstOrDefault();

    return new UserInfoDto
    {
        Id = user.Id,
        Username = user.Username,
        Name = user.Name,
        Email = user.Email,
        Phone = user.Phone,
        Role = userGroup?.Name ?? "User",
        IsActive = user.IsActive
    };
}
```

**Endpoint:** `GET /api/Account/current-user`

#### 3.2 ChangePasswordAsync âœ…
**Ø§Ù„ÙˆØµÙ:** ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

**Ø§Ù„ØªÙ†ÙÙŠØ°:**
```csharp
public async Task<bool> ChangePasswordAsync(int userId, string currentPassword, string newPassword, CancellationToken cancellationToken)
{
    var hashedCurrentPassword = HashPassword(currentPassword);
    var hashedNewPassword = HashPassword(newPassword);

    var user = await _identityContext.TblUsers
        .FirstOrDefaultAsync(u => u.Id == userId && u.Password == hashedCurrentPassword && u.IsActive, cancellationToken);

    if (user == null)
        return false;

    user.Password = hashedNewPassword;
    user.UpdatedDate = DateTime.UtcNow;

    await _identityContext.SaveChangesAsync(cancellationToken);

    // Revoke all existing tokens for security
    await RevokeAllUserTokensAsync(userId, cancellationToken);

    return true;
}
```

**Endpoint:** `POST /api/Account/change-password`

**Ø§Ù„Ø£Ù…Ø§Ù†:** ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ Tokens Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.

#### 3.3 ØªØ­Ø³ÙŠÙ† LoginResponseDto âœ…
**Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª:**
- `UserId`
- `Username`
- `Email`
- `Name`

---

### 4. Ù†Ø¸Ø§Ù… Permissions Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„

#### 4.1 UserPermissionService âœ…
**Ø§Ù„Ù…Ù„Ù:** `FormBuilder.Services/Services/account/UserPermissionService.cs`

**Methods Ø§Ù„Ù…Ø¶Ø§ÙØ©:**
1. `GetUserPermissionsAsync(int userId)` - Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ permissions Ù„Ù…Ø³ØªØ®Ø¯Ù…
2. `HasPermissionAsync(int userId, string permissionName)` - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† permission ÙˆØ§Ø­Ø¯
3. `CheckMultiplePermissionsAsync(int userId, IEnumerable<string> permissionNames)` - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø© permissions
4. `GetRolePermissionsAsync(int roleId)` - Ø¬Ù„Ø¨ permissions Ù„Ø¯ÙˆØ± Ù…Ø¹ÙŠÙ†
5. `GetPermissionMatrixAsync()` - Ø¬Ù„Ø¨ Permission Matrix ÙƒØ§Ù…Ù„

**Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
- âœ… Caching Ù„Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©
- âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Include Ù„ØªØ¬Ù†Ø¨ N+1 Queries
- âœ… AsNoTracking Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
- âœ… Methods Ù„Ø¥Ù„ØºØ§Ø¡ Cache

#### 4.2 Permission Matrix Management âœ…
**Ø§Ù„Ù…Ù„Ù:** `FormBuilder.Core/DTOS/Auth/PermissionMatrixDto.cs`

**DTOs:**
- `PermissionMatrixDto` - Permission Matrix ÙƒØ§Ù…Ù„
- `PermissionInfoDto` - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Permission
- `RolePermissionDto` - Permissions Ù„Ø¯ÙˆØ±
- `UserPermissionDto` - Permissions Ù„Ù…Ø³ØªØ®Ø¯Ù…
- `CheckPermissionRequestDto` - Request Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† permission
- `CheckPermissionsRequestDto` - Request Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø© permissions

**Response Example:**
```json
{
  "permissions": [
    {
      "name": "FormBuilder.Create",
      "description": "Create forms",
      "screenName": "FormBuilder",
      "isActive": true
    }
  ],
  "rolePermissions": [
    {
      "roleId": 1,
      "roleName": "Administration",
      "permissions": ["FormBuilder.Create", "FormBuilder.Edit", ...]
    }
  ]
}
```

#### 4.3 UserPermissionController âœ…
**Ø§Ù„Ù…Ù„Ù:** `frombuilderApiProject/Controllers/Auth/UserPermissionController.cs`

**Endpoints:**

| Method | Endpoint | Auth | Role | Ø§Ù„ÙˆØµÙ |
|--------|----------|------|------|-------|
| GET | `/api/UserPermission` | âœ… | Administration | Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Permissions |
| GET | `/api/UserPermission/user/{userId}` | âœ… | Administration | Ø¬Ù„Ø¨ permissions Ù„Ù…Ø³ØªØ®Ø¯Ù… |
| GET | `/api/UserPermission/current-user` | âœ… | - | Ø¬Ù„Ø¨ permissions Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ |
| POST | `/api/UserPermission/check` | âœ… | - | Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† permission ÙˆØ§Ø­Ø¯ |
| POST | `/api/UserPermission/check-multiple` | âœ… | - | Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø© permissions |
| GET | `/api/UserPermission/role/{roleId}` | âœ… | Administration | Ø¬Ù„Ø¨ permissions Ù„Ø¯ÙˆØ± |
| GET | `/api/UserPermission/matrix` | âœ… | Administration | Ø¬Ù„Ø¨ Permission Matrix |

#### 4.4 RequirePermission Attribute âœ…
**Ø§Ù„Ù…Ù„Ù:** `frombuilderApiProject/Attributes/RequirePermissionAttribute.cs`

**Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
```csharp
[RequirePermission("FormBuilder.Create")]
[HttpPost]
public async Task<IActionResult> CreateForm([FromBody] CreateFormDto dto)
{
    // ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… FormBuilder.Create permission ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ÙˆØµÙˆÙ„
}
```

**Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
- âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Permissions Ù…Ù† PermissionService (Ù…Ø¹ Cache)
- âœ… Ø¯Ø¹Ù… Multiple Permissions
- âœ… Integration Ù…Ø¹ ASP.NET Core Authorization

---

### 5. Rate Limiting Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

#### 5.1 Configuration Ù…Ù† appsettings.json âœ…
**Ø§Ù„Ù…Ù„Ù:** `frombuilderApiProject/appsettings.json`

```json
{
  "RateLimiting": {
    "Enabled": true,
    "GlobalLimit": {
      "MaxRequests": 100,
      "TimeWindowMinutes": 1
    },
    "EndpointLimits": {
      "/api/Account/login": {
        "MaxRequests": 5,
        "TimeWindowMinutes": 1
      },
      "/api/Account/refresh-token": {
        "MaxRequests": 10,
        "TimeWindowMinutes": 1
      },
      "/api/Account/change-password": {
        "MaxRequests": 3,
        "TimeWindowMinutes": 5
      }
    },
    "Whitelist": [],
    "Blacklist": [],
    "BypassPaths": [ "/swagger", "/health", "/api/Account/current-user" ]
  }
}
```

#### 5.2 RateLimitingMiddleware âœ…
**Ø§Ù„Ù…Ù„Ù:** `frombuilderApiProject/Middleware/RateLimitingMiddleware.cs`

**Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
- âœ… Global Rate Limit Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒÙˆÙŠÙ†
- âœ… Endpoint-specific Limits
- âœ… IP Whitelist (ØªØ®Ø·ÙŠ Rate Limiting)
- âœ… IP Blacklist (Ù…Ù†Ø¹ ÙƒØ§Ù…Ù„ - 403 Forbidden)
- âœ… Bypass Paths (Ù„Ù€ Swagger, Health checks)
- âœ… Client Identification (User ID + IP)
- âœ… Response Headers Ù…ÙØµÙ„Ø©
- âœ… Logging Ù…ÙØµÙ„
- âœ… Automatic Cleanup ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

**Response Headers:**
```
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 2
X-RateLimit-Reset: Mon, 01 Jan 2024 12:00:00 GMT
X-RateLimit-Used: 3
```

**Error Response:**
```json
{
  "error": "Too many requests",
  "message": "Rate limit exceeded. Maximum 5 requests per 1 minute(s).",
  "retryAfter": 45,
  "limit": 5,
  "windowMinutes": 1
}
```

#### 5.3 RateLimitingOptions âœ…
**Ø§Ù„Ù…Ù„Ù:** `FormBuilder.Core/Configuration/RateLimitingOptions.cs`

**Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
- âœ… Strongly-typed Configuration
- âœ… Default values
- âœ… Easy to extend

---

### 6. ØªØ­Ø³ÙŠÙ† JWT Token

#### 6.1 ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Token âœ…
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- ÙƒØ§Ù† ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Permissions ÙÙŠ JWT Token
- Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ø²ÙŠØ§Ø¯Ø© ÙƒØ¨ÙŠØ±Ø© ÙÙŠ Ø­Ø¬Ù… Token

**Ø§Ù„Ø­Ù„:**
- âœ… Ø¥Ø²Ø§Ù„Ø© Permissions Ù…Ù† JWT Claims
- âœ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ PermissionService (Ù…Ø¹ Cache) Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Permissions
- âœ… Token ÙŠØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰: UserId, Username, Role, Jti

**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Token Ø¨Ù†Ø³Ø¨Ø© 70-80%.

#### 6.2 ØªØ­Ø³ÙŠÙ† LoginResponseDto âœ…
**Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª:**
- `UserId`
- `Username`
- `Email`
- `Name`
- `ExpiresAt`
- `RefreshTokenExpiresAt`

---

## ğŸ“ˆ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡

### ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:

| Ø§Ù„Ø¹Ù…Ù„ÙŠØ© | Ù‚Ø¨Ù„ | Ø¨Ø¹Ø¯ | Ø§Ù„ØªØ­Ø³ÙŠÙ† |
|---------|-----|-----|---------|
| **LoginAsync** | 2-3 Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª + 2 SaveChanges = ~150-200ms | 1 Ø§Ø³ØªØ¹Ù„Ø§Ù… + 1 SaveChanges = ~50-80ms | **60-70% Ø£Ø³Ø±Ø¹** |
| **RefreshTokenAsync** | 2-3 Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª + 2 SaveChanges = ~150-200ms | 1 Ø§Ø³ØªØ¹Ù„Ø§Ù… + 1 SaveChanges = ~50-80ms | **60-70% Ø£Ø³Ø±Ø¹** |
| **GetAllRolesAsync** | Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…Ø±Ø© = ~20-30ms | Cache hit = ~1-2ms | **90-95% Ø£Ø³Ø±Ø¹** |
| **GetAllAsync (Permissions)** | Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…Ø±Ø© = ~20-30ms | Cache hit = ~1-2ms | **90-95% Ø£Ø³Ø±Ø¹** |
| **JWT Token Size** | ÙƒØ¨ÙŠØ± (Ù…Ø¹ Permissions) | ØµØºÙŠØ± (Ø¨Ø¯ÙˆÙ† Permissions) | **70-80% Ø£ØµØºØ±** |

---

## ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©/Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©

### Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©:
1. âœ… `FormBuilder.Core/DTOS/Auth/PermissionMatrixDto.cs`
2. âœ… `frombuilderApiProject/Attributes/RequirePermissionAttribute.cs`
3. âœ… `frombuilderApiProject/Middleware/RateLimitingMiddleware.cs`
4. âœ… `FormBuilder.Core/Configuration/RateLimitingOptions.cs`

### Ù…Ù„ÙØ§Øª Ù…Ø¹Ø¯Ù„Ø©:
1. âœ… `FormBuilder.Services/Services/account/AuthService.cs`
   - ØªØ­Ø³ÙŠÙ† `LoginAsync` Ùˆ `RefreshTokenAsync`
   - Ø¥Ø¶Ø§ÙØ© `GetCurrentUserAsync`
   - Ø¥Ø¶Ø§ÙØ© `ChangePasswordAsync`
   - ØªØ­Ø³ÙŠÙ† `RevokeOldRefreshTokensAsync`
   - Ø¥Ø²Ø§Ù„Ø© Permissions Ù…Ù† JWT Token

2. âœ… `FormBuilder.Services/Services/account/UserPermissionService.cs`
   - Ø¥Ø¶Ø§ÙØ© 5 methods Ø¬Ø¯ÙŠØ¯Ø©
   - Ø¥Ø¶Ø§ÙØ© Caching
   - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡

3. âœ… `FormBuilder.Services/Services/account/RoleService.cs`
   - Ø¥Ø¶Ø§ÙØ© Caching
   - Ø¥Ø¶Ø§ÙØ© AsNoTracking

4. âœ… `frombuilderApiProject/Controllers/Auth/AccountController.cs`
   - Ø¥Ø¶Ø§ÙØ© `GetCurrentUser` endpoint
   - Ø¥Ø¶Ø§ÙØ© `ChangePassword` endpoint
   - Ø¥Ø¶Ø§ÙØ© `RevokeAllUserTokens` endpoint

5. âœ… `frombuilderApiProject/Controllers/Auth/UserPermissionController.cs`
   - Ø¥Ø¶Ø§ÙØ© 6 endpoints Ø¬Ø¯ÙŠØ¯Ø©
   - Ø¥Ø¶Ø§ÙØ© Authorization

6. âœ… `FormBuilder.Core/IServices/Auth/IUserPermissionService.cs`
   - Ø¥Ø¶Ø§ÙØ© 5 methods Ø¬Ø¯ÙŠØ¯Ø©

7. âœ… `FormBuilder.Core/DTOS/account/LoginRequestDto.cs`
   - ØªØ­Ø¯ÙŠØ« `LoginResponseDto`
   - Ø¥Ø¶Ø§ÙØ© `UserInfoDto`
   - Ø¥Ø¶Ø§ÙØ© `ChangePasswordRequestDto`

8. âœ… `frombuilderApiProject/Program.cs`
   - Ø¥Ø¶Ø§ÙØ© `AddMemoryCache()`
   - Ø¥Ø¶Ø§ÙØ© Rate Limiting Configuration
   - Ø¥Ø¶Ø§ÙØ© `UseRateLimiting()` middleware

9. âœ… `frombuilderApiProject/appsettings.json`
   - Ø¥Ø¶Ø§ÙØ© RateLimiting configuration section

---

## ğŸ” Ø§Ù„Ø£Ù…Ø§Ù†

### 1. Authentication & Authorization:
- âœ… JWT Token-based Authentication
- âœ… Refresh Token Rotation
- âœ… Role-based Authorization
- âœ… Permission-based Authorization
- âœ… Token Revocation Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

### 2. Rate Limiting:
- âœ… Ø­Ù…Ø§ÙŠØ© Ù…Ù† DDoS attacks (Global Limit: 100 requests/minute)
- âœ… Ø­Ù…Ø§ÙŠØ© Ù…Ù† Brute Force attacks (Login: 5 requests/minute)
- âœ… IP Whitelist/Blacklist
- âœ… Endpoint-specific Limits

### 3. Password Security:
- âœ… SHA512 Hashing
- âœ… Token Revocation Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

### 4. Token Security:
- âœ… JWT Token Validation
- âœ… Refresh Token Expiry
- âœ… Automatic Token Cleanup (Ø£Ø­Ø¯Ø« 5 tokens ÙÙ‚Ø·)

---

## ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

| Ø§Ù„Ù…ÙŠØ²Ø© | Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„Ù…Ù„ÙØ§Øª |
|--------|--------|---------|
| Performance Optimization | âœ… Ù…ÙƒØªÙ…Ù„ | 3 Ù…Ù„ÙØ§Øª |
| Authentication Completion | âœ… Ù…ÙƒØªÙ…Ù„ | 2 Ù…Ù„ÙØ§Øª |
| Permission System | âœ… Ù…ÙƒØªÙ…Ù„ | 4 Ù…Ù„ÙØ§Øª |
| Rate Limiting | âœ… Ù…ÙƒØªÙ…Ù„ | 3 Ù…Ù„ÙØ§Øª |
| JWT Token Optimization | âœ… Ù…ÙƒØªÙ…Ù„ | 1 Ù…Ù„Ù |
| **Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹** | **âœ… 5/5** | **13 Ù…Ù„Ù** |

---

## ğŸ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Permission ÙÙŠ Controller:
```csharp
[RequirePermission("FormBuilder.Create")]
[HttpPost]
public async Task<IActionResult> CreateForm([FromBody] CreateFormDto dto)
{
    // Code here
}
```

### 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Permission Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹:
```csharp
var hasPermission = await _permissionService.HasPermissionAsync(userId, "FormBuilder.Create");
```

### 3. Ø¬Ù„Ø¨ Permissions Ù„Ù…Ø³ØªØ®Ø¯Ù…:
```csharp
var permissions = await _permissionService.GetUserPermissionsAsync(userId);
```

### 4. Permission Matrix:
```csharp
var matrix = await _permissionService.GetPermissionMatrixAsync();
```

### 5. Rate Limiting Configuration:
```json
{
  "RateLimiting": {
    "Enabled": true,
    "GlobalLimit": {
      "MaxRequests": 100,
      "TimeWindowMinutes": 1
    },
    "EndpointLimits": {
      "/api/Account/login": {
        "MaxRequests": 5,
        "TimeWindowMinutes": 1
      }
    }
  }
}
```

---

## âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

- âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
- âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø°ÙŠØ±Ø§Øª
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
- âœ… Dependency Injection ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- âœ… Configuration ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù…Ø®ØªØ¨Ø±Ø©

---

## ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª

### 1. User Permission Overrides:
- Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø¶Ø§ÙØ© User Override Permissions
- TODO Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ `GetUserPermissionsAsync` Ù„Ø¥Ø¶Ø§ÙØ© Overrides

### 2. Cache Invalidation:
- Methods Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Cache Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
- ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Permissions

### 3. Rate Limiting:
- Configurable Ù…Ù† `appsettings.json`
- ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡ Ù„ÙƒÙ„ endpoint Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
- ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Redis Ù„Ù„Ù€ Distributed Rate Limiting ÙÙŠ Production

### 4. Token Size:
- ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Token Ø¨Ø¥Ø²Ø§Ù„Ø© Permissions
- Permissions ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§ Ù…Ù† PermissionService (Ù…Ø¹ Cache)
- Ù‡Ø°Ø§ ÙŠÙˆÙØ± Ø£ÙØ¶Ù„ ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ­Ø¬Ù… Token

---

## ğŸš€ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©

### 1. Production Enhancements:
- Ø§Ø³ØªØ®Ø¯Ø§Ù… Redis Ù„Ù„Ù€ Distributed Caching
- Ø§Ø³ØªØ®Ø¯Ø§Ù… Redis Ù„Ù„Ù€ Distributed Rate Limiting
- Ø¥Ø¶Ø§ÙØ© Monitoring Ùˆ Alerting
- Ø¥Ø¶Ø§ÙØ© Audit Logging

### 2. Security Enhancements:
- Ø¥Ø¶Ø§ÙØ© Two-Factor Authentication (2FA)
- Ø¥Ø¶Ø§ÙØ© Password Complexity Rules
- Ø¥Ø¶Ø§ÙØ© Account Lockout Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø©
- Ø¥Ø¶Ø§ÙØ© IP-based Geolocation

### 3. Performance Enhancements:
- Ø¥Ø¶Ø§ÙØ© Database Indexes Ø¹Ù„Ù‰ Username Ùˆ Password
- Ø¥Ø¶Ø§ÙØ© Response Compression
- Ø¥Ø¶Ø§ÙØ© CDN Ù„Ù„Ù€ Static Assets

---

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„:** 2024-01-XX  
**Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… Ù…ÙƒØªÙ…Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…  
**Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:** ØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
