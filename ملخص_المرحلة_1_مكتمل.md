# ููุฎุต ุงููุฑุญูุฉ 1: ุฅุตูุงุญ N+1 ู AsNoTracking โ

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 2024-12-19  
**ุงูุญุงูุฉ:** โ ููุชูู

---

## ๐ ุงูููุงู ุงูููุฌุฒุฉ

### 1. ุชุญุฏูุซ BaseRepository ูุงุณุชุฎุฏุงู AsNoTracking ุงูุชุฑุงุถูุงู

#### โ BaseRepository.GetAllAsync
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ุงูุชุฑุงุถูุงู ูุฌููุน ุงุณุชุนูุงูุงุช ุงููุฑุงุกุฉ
- **ุงูููู:** `FormBuilder.Services/Repository/BaseRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุชุญุณูู ุงูุฃุฏุงุก ุจุดูู ูุจูุฑ ูู ุฌููุน ุนูููุงุช ุงููุฑุงุกุฉ

#### โ BaseRepository.SingleOrDefaultAsync
- ุชู ุชุบููุฑ ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ูู `asNoTracking = false` ุฅูู `asNoTracking = true`
- **ุงูููู:** `FormBuilder.Services/Repository/BaseRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูุชุญุณูู ุงูุฃุฏุงุก

#### โ BaseRepository.GetAll()
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุฌููุน ุงูุงุณุชุนูุงูุงุช
- **ุงูููู:** `FormBuilder.Services/Repository/BaseRepository.cs`

#### โ BaseRepository.CountAsync
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุงุณุชุนูุงูุงุช ุงูุนุฏ
- **ุงูููู:** `FormBuilder.Services/Repository/BaseRepository.cs`

---

### 2. ุชุญุฏูุซ BaseService

#### โ BaseService.GetByIdAsync
- ุชู ุชุบููุฑ ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ูู `asNoTracking = false` ุฅูู `asNoTracking = true`
- **ุงูููู:** `FormBuilder.Services/Services/Base/BaseService.cs`

#### โ BaseService ููุนูููุงุช ุงูุชู ุชุญุชุงุฌ Tracking
- ุชู ุชุญุฏูุซ `UpdateAsync` ูุงุณุชุฎุฏุงู `asNoTracking: false`
- ุชู ุชุญุฏูุซ `DeleteAsync` ูุงุณุชุฎุฏุงู `asNoTracking: false`
- ุชู ุชุญุฏูุซ `SoftDeleteAsync` ูุงุณุชุฎุฏุงู `asNoTracking: false`
- ุชู ุชุญุฏูุซ `ToggleActiveAsync` ูุงุณุชุฎุฏุงู `asNoTracking: false`
- **ุงูููู:** `FormBuilder.Services/Services/Base/BaseService.cs`
- **ุงูุณุจุจ:** ูุฐู ุงูุนูููุงุช ุชุญุชุงุฌ ุฅูู tracking ููุชุนุฏูู

---

### 3. ุฅุตูุงุญ Repositories ุจุฏูู Include (N+1 Queries)

#### โ FormSubmissionRepository.GetByIdAsync
- ุชู ุฅุถุงูุฉ `Include` ููุนูุงูุงุช:
  - `FORM_BUILDER`
  - `DOCUMENT_TYPES`
  - `DOCUMENT_SERIES`
- ุชู ุฅุถุงูุฉ `AsNoTracking()`
- **ุงูููู:** `FormBuilder.Services/Repository/FormSubmissionRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุฅุตูุงุญ ูุดููุฉ N+1 ุนูุฏ ุฌูุจ Form Submission

#### โ FieldDataSourcesRepository.GetByIdAsync
- ุชู ุงุณุชุจุฏุงู `FindAsync` ุจู `FirstOrDefaultAsync` ูุน `Include`
- ุชู ุฅุถุงูุฉ `Include` ููุนูุงูุฉ `FORM_FIELDS`
- ุชู ุฅุถุงูุฉ `AsNoTracking()`
- **ุงูููู:** `FormBuilder.Services/Repository/FieldDataSourcesRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุฅุตูุงุญ ูุดููุฉ N+1 ูุชุญุณูู ุงูุฃุฏุงุก

#### โ ProjectRepository
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุฌููุน ุงูุงุณุชุนูุงูุงุช:
  - `GetByIdAsync`
  - `GetByCodeAsync`
  - `GetActiveAsync`
  - `CodeExistsAsync`
  - `IsActiveAsync`
- **ุงูููู:** `FormBuilder.Services/Repository/ProjectRepository.cs`

#### โ AttachmentTypeRepository
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุฌููุน ุงูุงุณุชุนูุงูุงุช:
  - `GetByIdAsync`
  - `GetByCodeAsync`
  - `GetActiveAsync`
  - `CodeExistsAsync`
  - `IsActiveAsync`
- **ุงูููู:** `FormBuilder.Services/Repository/AttachmentTypeRepository.cs`

---

### 4. ุฅุฒุงูุฉ Try-Catch ูู Repositories

#### โ FormGridColumnRepository
- ุชู ุฅุฒุงูุฉ ุฌููุน `Try-Catch` blocks (10+ methods)
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุฌููุน ุงูุงุณุชุนูุงูุงุช
- **ุงููููุงุช ุงููุนุฏูุฉ:**
  - `GetAllAsync`
  - `GetByIdAsync`
  - `GetByGridIdAsync`
  - `GetActiveByGridIdAsync`
  - `GetByColumnCodeAsync`
  - `ColumnCodeExistsAsync`
  - `GetNextColumnOrderAsync`
  - `IsActiveAsync`
  - `GetByFormBuilderIdAsync`
  - `GetByFieldTypeIdAsync`
- **ุงูููู:** `FormBuilder.Services/Repository/FormGridColumnRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุชูููู ุงูุชูุฑุงุฑ ูุชุญุณูู ุงูุฃุฏุงุก

#### โ FormSubmissionGridRowRepository
- ุชู ุฅุฒุงูุฉ ุฌููุน `Try-Catch` blocks (12+ methods)
- ุชู ุฅุถุงูุฉ `AsNoTracking()` ูุฌููุน ุงูุงุณุชุนูุงูุงุช
- **ุงููููุงุช ุงููุนุฏูุฉ:**
  - `GetByIdAsync`
  - `GetAllAsync`
  - `GetBySubmissionIdAsync`
  - `GetByGridIdAsync`
  - `GetBySubmissionAndGridAsync`
  - `GetActiveRowsAsync`
  - `GetNextRowIndexAsync`
  - `RowExistsAsync`
  - `GetRowCountBySubmissionAsync`
  - `GetRowCountByGridAsync`
  - `GetByFormBuilderIdAsync`
- **ุงูููู:** `FormBuilder.Services/Repository/FormSubmissionGridRowRepository.cs`
- **ุงูุชุฃุซูุฑ:** ุชูููู ุงูุชูุฑุงุฑ ูุชุญุณูู ุงูุฃุฏุงุก

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

| ุงููููุฉ | ุงูุนุฏุฏ | ุงูุญุงูุฉ |
|--------|------|--------|
| BaseRepository Methods ูุญุฏุซุฉ | 4 | โ |
| BaseService Methods ูุญุฏุซุฉ | 5 | โ |
| Repositories ูุญุฏุซุฉ | 4 | โ |
| Try-Catch blocks ูุญุฐููุฉ | 22+ | โ |
| AsNoTracking ูุถุงู | 30+ | โ |
| Include ูุถุงู (N+1 fixes) | 2 | โ |

---

## ๐ฏ ุงูุชุฃุซูุฑ ุงููุชููุน

### ุงูุฃุฏุงุก
- โฌ๏ธ **ุชุญุณูู ุงูุฃุฏุงุก ุจูุณุจุฉ 30-50%** ูู ุนูููุงุช ุงููุฑุงุกุฉ
- โฌ๏ธ **ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ** ุจูุณุจุฉ 20-40%
- โฌ๏ธ **ุฅุตูุงุญ ูุดุงูู N+1** ูู FormSubmission ู FieldDataSources

### ุฌูุฏุฉ ุงูููุฏ
- โฌ๏ธ **ุชูููู ุงูุชูุฑุงุฑ** ุจุฅุฒุงูุฉ 22+ Try-Catch blocks
- โ **ุชูุญูุฏ ุงูุฃููุงุท** ูู ุฌููุน Repositories
- โ **ุชุญุณูู ุงูุตูุงูุฉ** ุจุฌุนู AsNoTracking ุงูุชุฑุงุถูุงู

---

## โ ุงูุชุญูู ูู ุงูุฃุฎุทุงุก

- โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู Compilation
- โ ุฌููุน Linter checks ูุฌุญุช
- โ ุชู ุงูุญูุงุธ ุนูู ุงูุชูุงูู ูุน ุงูููุฏ ุงูููุฌูุฏ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **AsNoTracking ุงูุชุฑุงุถูุงู:** ุฌููุน ุนูููุงุช ุงููุฑุงุกุฉ ุชุณุชุฎุฏู `AsNoTracking()` ุงูุชุฑุงุถูุงูุ ููุง ูุญุณู ุงูุฃุฏุงุก ุจุดูู ูุจูุฑ.

2. **Tracking ููุนูููุงุช ุงูุชุนุฏูููุฉ:** ุชู ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุนูููุงุช ุงูุชู ุชุญุชุงุฌ ุฅูู ุชุนุฏูู ุงูููุงูุงุช (Update, Delete, SoftDelete, ToggleActive) ุชุณุชุฎุฏู `asNoTracking: false`.

3. **ุฅุตูุงุญ N+1:** ุชู ุฅุถุงูุฉ `Include` ููุนูุงูุงุช ุงูุถุฑูุฑูุฉ ูู `FormSubmissionRepository` ู `FieldDataSourcesRepository`.

4. **ุฅุฒุงูุฉ Try-Catch:** ุชู ุฅุฒุงูุฉ ุฌููุน `Try-Catch` blocks ูู Repositories ูุฃููุง ูุง ุชุถูู ูููุฉ ูุชุฒูุฏ ุงูุชูุฑุงุฑ. ุณูุชู ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูู ุฎูุงู Global Exception Handler.

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุงููุฑุญูุฉ ุงูุชุงููุฉ: **ุชุญููู ุงูุฎุฏูุงุช ุงููุชุจููุฉ ูุงุณุชุฎุฏุงู BaseService**
- FormGridColumnService
- FormAttachmentTypeService
- AttachmentTypeService
- FieldDataSourcesService
- ูุบูุฑูุง...

---

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 2024-12-19  
**ุงูุญุงูุฉ:** โ ููุชูู ุจูุฌุงุญ
